# Динамический SQL в ESQL/C с PostgreSQL

## Описание программы

Программа демонстрирует использование **динамического SQL** в ESQL/C: подготовку операторов (`PREPARE`), выполнение с параметрами (`EXECUTE ... USING`) и работу с курсорами для параметризованных запросов.

Подключается к учебной базе данных `students`, переходит в схему `pmib2713` и предоставляет интерактивное меню для выполнения трёх аналитических задач по классической базе SPJ (Поставщики — Детали — Изделия — Поставки).

### Структура таблиц

| Таблица | Поля                              |
|---------|-----------------------------------|
| `s`     | n_post, name, reiting, town       |
| `p`     | n_det, name, cvet, ves, town      |
| `j`     | n_izd, name, town                 |
| `spj`   | n_post, n_det, n_izd, kol         |

## Выполняемые задачи

### Задача 1: Среднее от максимальных объёмов поставок

Вычисляет среднее значение от максимальных объёмов поставок для каждого изделия.

**Тип запроса:** однострочный (без курсора)

```sql
SELECT ROUND(AVG(b.max_kol), 2) AS sr_max_kol
FROM (
    SELECT MAX(kol) AS max_kol
    FROM pmib2713.spj
    GROUP BY n_izd
) b
```

**Пример вывода:**
```
Среднее максимальных объемов поставок для каждого изделия: 571.43
```

---

### Задача 2: Средний объём поставок для поставщика S*

Для заданного поставщика (вводится пользователем) выводит информацию об изделиях и средний объём поставок по каждому.

**Тип запроса:** многострочный с параметром (курсор + `USING`)

```sql
SELECT j.n_izd, j.name, j.town, b.sr_kol
FROM (
    SELECT n_izd, AVG(kol) AS sr_kol
    FROM pmib2713.spj
    WHERE n_post = ?
    GROUP BY n_izd
) b
JOIN pmib2713.j AS j ON b.n_izd = j.n_izd
ORDER BY j.n_izd
```

**Пример вывода для S2:**
```
+--------+------------------+---------------+-----------+
| ИЗД №  | НАЗВАНИЕ ИЗДЕЛИЯ | ГОРОД ИЗДЕЛИЯ | СР. ОБЪЕМ |
+--------+------------------+---------------+-----------+
| J1     | Жесткий диск     | Париж         |    400.00 |
| J2     | Перфоратор       | Рим           |    150.00 |
| J3     | Считыватель      | Афины         |    200.00 |
| J4     | Принтер          | Афины         |    500.00 |
| J5     | Флоппи-диск      | Лондон        |    600.00 |
| J6     | Терминал         | Осло          |    400.00 |
| J7     | Лента            | Лондон        |    800.00 |
+--------+------------------+---------------+-----------+
```

---

### Задача 3: Процент поставок по цвету для изделия J*

Для заданного изделия (вводится пользователем) вычисляет статистику поставок в разрезе цветов деталей: количество поставок каждого цвета и их процент от общего числа.

**Тип запроса:** многострочный с двумя параметрами (курсор + `USING`)

```sql
SELECT a.cvet, a.to_cvet, b.total, ROUND(a.to_cvet * 100.0 / b.total, 2) AS percent
FROM (
    SELECT p.cvet, COUNT(*) AS to_cvet
    FROM pmib2713.spj
    JOIN pmib2713.p AS p ON pmib2713.spj.n_det = p.n_det
    WHERE pmib2713.spj.n_izd = ?
    GROUP BY p.cvet
) a
CROSS JOIN (
    SELECT COUNT(*) AS total
    FROM pmib2713.spj
    WHERE n_izd = ?
) b
```

**Пример вывода для J4:**
```
+-------------+-------------+----------------+-------------+
| ЦВЕТ ДЕТАЛИ | ЧИСЛО ПОСТ. | ВСЕГО ПОСТ. J* | ПРОЦЕНТ (%) |
+-------------+-------------+----------------+-------------+
| Красный     |           2 |              3 |       66.67 |
| Зеленый     |           1 |              3 |       33.33 |
+-------------+-------------+----------------+-------------+
```

## Особенности реализации

### Динамический SQL
- **`PREPARE stmt FROM :text`** — подготовка SQL-оператора из строковой переменной
- **`EXECUTE stmt INTO :var`** — выполнение однострочного запроса
- **`DECLARE cursor CURSOR FOR stmt`** — объявление курсора для подготовленного оператора
- **`OPEN cursor USING :param`** — открытие курсора с подстановкой параметров (`?`)

### Управление транзакциями
- Явные транзакции (`BEGIN WORK` / `COMMIT WORK` / `ROLLBACK WORK`)
- Проверка результатов всех SQL-операций через `sqlca.sqlcode`
- Корректный откат при ошибках

### Обработка данных
- Использование NULL-индикаторов для всех переменных результата
- Корректная проверка NULL: `indicator < 0` (не только `-1`)
- Удаление trailing-пробелов из CHAR-полей PostgreSQL (`rtrim`)
- Корректный вывод UTF-8 строк с выравниванием в таблицах

### Защита ввода
- Безопасное чтение строк через `fgets` + удаление `\n`
- Очистка буфера ввода после `scanf`
- Проверка на пустой ввод

## Сборка и запуск

```bash
# 1. Прекомпиляция ESQL/C в C
pgcci lab_4

# 3. Запуск
./lab_4.exe
```

## Структура кода

| Функция | Описание |
|---------|----------|
| `ConnectDB()` | Подключение к БД, установка схемы и кодировки |
| `DisconnectDB()` | Отключение от БД |
| `PrepareStatements()` | Подготовка всех SQL-операторов |
| `PrintMenu()` | Вывод меню |
| `Task1()` | Однострочный запрос без параметров |
| `Task2()` | Многострочный запрос с 1 параметром |
| `Task3()` | Многострочный запрос с 2 параметрами |

### Вспомогательные функции

| Функция | Описание |
|---------|----------|
| `rtrim()` | Удаление пробелов справа из строки |
| `clear_input_buffer()` | Очистка буфера stdin |
| `read_line()` | Безопасное чтение строки |
| `utf8_strlen()` | Подсчёт UTF-8 символов |
| `print_utf8_padded()` | Вывод строки с выравниванием по UTF-8 ширине |

